<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Output Booster (Final Pro)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* (ê¸°ì¡´ CSS ìŠ¤íƒ€ì¼ ìœ ì§€ - ìƒëµ) */
        body { padding: 0; margin: 0; background: #F0F2F5; font-family: 'Noto Sans KR', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        .header { background: white; padding: 15px 30px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { color: #00875A; font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; margin: 0; }
        .main-tabs { display: flex; background: #E9ECEF; padding: 5px; border-radius: 30px; gap: 5px; }
        .m-tab { padding: 8px 20px; border-radius: 20px; border: none; font-weight: 700; cursor: pointer; color: #666; transition: 0.2s; font-size: 14px; }
        .m-tab.active { background: #00875A; color: white; }
        .content-area { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        .module-view { display: none; height: 100%; }
        .module-view.active { display: block; }
        .sub-nav { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .sub-btn { background: none; border: none; font-weight: bold; color: #888; cursor: pointer; font-size: 15px; padding: 10px 5px; border-bottom: 3px solid transparent; }
        .sub-btn.active { color: #00875A; border-bottom-color: #00875A; }
        .split-container { display: flex; gap: 30px; height: calc(100vh - 200px); }
        .left-panel { flex: 1.2; background: white; padding: 25px; border-radius: 12px; overflow-y: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .right-panel { flex: 0.8; display: flex; justify-content: center; align-items: flex-start; padding-top: 10px; }
        .select-group { margin-bottom: 20px; }
        .form-select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; background: #F8F9FB; color: #333; cursor: pointer; margin-bottom: 10px; font-weight: 500; }
        .editor-section { border-top: 2px dashed #eee; padding-top: 20px; margin-top: auto; flex: 1; display: flex; flex-direction: column; }
        .form-label { font-size: 12px; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; margin-bottom: 15px; }
        .form-textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: none; margin-bottom: 15px; font-family: inherit; line-height: 1.5; }
        .hint-container { border: 1px solid #eee; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; background: #FAFAFA; }
        .hint-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .hint-chip { font-size: 12px; padding: 6px 12px; background: white; border: 1px solid #ccc; border-radius: 20px; cursor: pointer; transition: 0.2s; user-select: none; }
        .hint-chip.checked { background: #FFF0B3; color: #B76E00; border-color: #B76E00; font-weight: bold; }
        .mobile-frame { width: 300px; height: 620px; background: #fff; border: 12px solid #2D3748; border-radius: 35px; position: relative; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .mobile-notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 120px; height: 25px; background: #2D3748; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; z-index: 10; }
        .mobile-screen { padding: 45px 20px 20px; height: 100%; background: #F4F5F7; overflow-y: auto; display: flex; flex-direction: column; }
        .preview-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-top: 10px; }
        .p-tag { font-size: 10px; font-weight: bold; color: #00875A; background: #E3FCEF; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-bottom: 10px; }
        .p-title { font-size: 18px; font-weight: 800; margin-bottom: 10px; color: #333; line-height: 1.3; }
        .p-desc { font-size: 13px; color: #666; line-height: 1.6; margin-bottom: 20px; }
        .p-hints-box { background: #FFFAE6; padding: 15px; border-radius: 10px; border: 1px solid #FEEBC8; }
        .p-hints-title { font-size: 12px; font-weight: bold; color: #B76E00; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .p-hints-list { margin: 0; padding-left: 20px; font-size: 12px; color: #555; line-height: 1.5; }
        .fb-container { display: flex; gap: 25px; height: calc(100vh - 200px); }
        .fb-list-panel { flex: 1; background: white; padding: 20px; border-radius: 12px; overflow-y: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .fb-detail-panel { flex: 2; background: white; padding: 30px; border-radius: 12px; overflow-y: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .sub-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .sub-item:hover { background: #F8F9FB; }
        .sub-item.active { background: #E6F0FF; border-left: 4px solid #0052CC; }
        .sub-name { font-weight: bold; font-size: 15px; }
        .sub-meta { font-size: 12px; color: #888; margin-top: 4px; }
        .student-work-area { background: #F8F9FB; padding: 20px; border-radius: 8px; min-height: 150px; border: 1px solid #eee; margin-bottom: 20px; font-family: 'Times New Roman', serif; font-size: 16px; line-height: 1.6; }
        .feedback-editor { width: 100%; height: 120px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; resize: none; background: #FFFCF2; font-size: 14px; margin-bottom: 15px; }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; color: white; transition: 0.2s; font-size: 14px; }
        .btn-send { background: #FAE100; color: #3C1E1E; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-ai { background: #0052CC; color: white; font-size: 12px; padding: 6px 12px; border-radius: 6px; }
        .btn-ghost { background: #f0f2f5; color: #555; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 30px; border-radius: 16px; width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .chk-item { padding: 8px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #f5f5f5; }
    </style>
    <script type="module" src="firebase-config.js"></script>
</head>
<body>

<div class="header">
    <h2><i class="fa-solid fa-microphone-lines"></i> Output Booster</h2>
    <div class="main-tabs">
        <button class="m-tab" onclick="switchMain('writeback')">WriteBack</button>
        <button class="m-tab active" onclick="switchMain('writing')">Writing Workshop</button>
        <button class="m-tab" onclick="switchMain('speaking')">Speaking Workshop</button>
    </div>
</div>

<div class="content-area">
    <div id="view-writeback" class="module-view">
        <iframe src="https://writeback-462607.web.app/" style="width:100%; height:100%; border:none; border-radius: 12px;"></iframe>
    </div>

    <div id="view-writing" class="module-view active">
        <div class="sub-nav">
            <button class="sub-btn active" id="btn-w-assign" onclick="switchSub('w-assign', this)">ì£¼ì œ ë°°í¬ (Assign)</button>
            <button class="sub-btn" id="btn-w-feedback" onclick="switchSub('w-feedback', this)">ê³¼ì œ í™•ì¸ ë° í”¼ë“œë°± (Feedback)</button>
        </div>
        <div id="w-assign" class="sub-view">
            <div class="split-container">
                <div class="left-panel">
                    <h3 style="margin-top:0;">1. ì£¼ì œ ì„ íƒ (Topic Selection)</h3>
                    <div class="select-group">
                        <label class="form-label">ëŒ€ìƒ í•™ë…„ (Target Grade)</label>
                        <select id="w-grade-select" class="form-select" onchange="loadTopics('Writing')">
                            <option value="elem_low">ì´ˆë“± 1~2í•™ë…„</option>
                            <option value="elem_mid">ì´ˆë“± 3~4í•™ë…„</option>
                            <option value="elem_high">ì´ˆë“± 5~6í•™ë…„</option>
                            <option value="mid_1">ì¤‘ë“± 1í•™ë…„</option>
                            <option value="mid_2">ì¤‘ë“± 2í•™ë…„</option>
                            <option value="mid_3">ì¤‘ë“± 3í•™ë…„</option>
                            <option value="high_1">ê³ ë“± 1í•™ë…„</option>
                            <option value="high_2">ê³ ë“± 2í•™ë…„</option>
                            <option value="high_3">ê³ ë“± 3í•™ë…„</option>
                        </select>
                        <label class="form-label">ì£¼ì œ ëª©ë¡ (Topic List)</label>
                        <select id="w-topic-select" class="form-select" onchange="applyTopic('Writing')"></select>
                    </div>
                    <div class="editor-section">
                        <h3 style="font-size:16px; margin-top:0;">2. ë‚´ìš© í¸ì§‘ (Editor)</h3>
                        <label class="form-label">ì œëª©</label>
                        <input type="text" id="w-edit-title" class="form-input" onkeyup="updatePreview('Writing')">
                        <label class="form-label">ê°€ì´ë“œ</label>
                        <textarea id="w-edit-prompt" class="form-textarea" onkeyup="updatePreview('Writing')"></textarea>
                        <label class="form-label">ìœ ìš©í•œ í‘œí˜„</label>
                        <div class="hint-container"><div id="w-edit-hints" class="hint-group"></div></div>
                        <button class="btn btn-send" style="width:100%; margin-top:20px;" onclick="openAssignModal('Writing')"><i class="fa-solid fa-paper-plane"></i> ìˆ™ì œ ì „ì†¡</button>
                    </div>
                </div>
                <div class="right-panel">
                    <div class="mobile-frame">
                        <div class="mobile-notch"></div>
                        <div class="mobile-screen">
                            <div style="text-align: center; margin-bottom: 20px;"><span style="font-size: 14px; color: #888;">Student App Preview</span></div>
                            <div class="preview-card">
                                <span class="p-tag">Writing</span>
                                <div class="p-title" id="w-prev-title">Topic Title</div>
                                <div class="p-desc" id="w-prev-prompt">Prompt text...</div>
                                <div class="p-hints-box" id="w-prev-hints" style="display:none;">
                                    <div class="p-hints-title"><i class="fa-regular fa-lightbulb"></i> Useful Expressions</div>
                                    <ul id="w-prev-hints-list" class="p-hints-list"></ul>
                                </div>
                            </div>
                            <div style="margin-top: 20px; text-align: center;">
                                <div style="width: 100%; height: 150px; border: 2px dashed #ddd; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #aaa; background: white;">Writing Input Area</div>
                                <button style="width: 100%; padding: 15px; background: #0052CC; color: white; border: none; border-radius: 8px; margin-top: 10px; font-weight: bold;">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="w-feedback" class="sub-view" style="display:none;">
            <div class="fb-container">
                <div class="fb-list-panel">
                    <h3 style="margin-top:0;">ğŸ“¥ ì œì¶œëœ ê³¼ì œ</h3>
                    <div id="w-submission-list"></div>
                </div>
                <div class="fb-detail-panel" id="w-detail-panel" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <div><h2 style="margin:0; font-size:20px;" id="w-fb-student">Student</h2><span style="color:#666; font-size:14px;" id="w-fb-title">Title</span></div>
                        <button class="btn-ai" onclick="generateAI('Writing')"><i class="fa-solid fa-wand-magic-sparkles"></i> AI ì²¨ì‚­ ìƒì„±</button>
                    </div>
                    <div class="student-work-area" id="w-fb-content"></div>
                    <label class="form-label">ì„ ìƒë‹˜ í”¼ë“œë°±</label>
                    <textarea id="w-fb-text" class="feedback-editor"></textarea>
                    <button class="btn btn-send" style="width:100%;" onclick="sendFeedback('Writing')"><i class="fa-solid fa-paper-plane"></i> í”¼ë“œë°± ì „ì†¡ ë° ì™„ë£Œ</button>
                </div>
                <div class="fb-detail-panel" id="w-empty-state" style="align-items:center; justify-content:center; color:#999;"><i class="fa-regular fa-folder-open" style="font-size:50px; margin-bottom:15px;"></i><p>ì™¼ìª½ ëª©ë¡ì—ì„œ í™•ì¸í•˜ê³  ì‹¶ì€ ê³¼ì œë¥¼ ì„ íƒí•˜ì„¸ìš”.</p></div>
            </div>
        </div>
    </div>

    <div id="view-speaking" class="module-view">
        <div class="sub-nav">
            <button class="sub-btn active" onclick="switchSub('s-assign', this)">ì£¼ì œ ë°°í¬ (Assign)</button>
            <button class="sub-btn" onclick="switchSub('s-feedback', this)">ê³¼ì œ í™•ì¸ ë° í”¼ë“œë°± (Feedback)</button>
        </div>
        <div id="s-assign" class="sub-view">
            <div class="split-container">
                <div class="left-panel">
                    <h3 style="margin-top:0;">1. ì£¼ì œ ì„ íƒ (Topic Selection)</h3>
                    <div class="select-group">
                        <label class="form-label">ëŒ€ìƒ í•™ë…„</label>
                        <select id="s-grade-select" class="form-select" onchange="loadTopics('Speaking')">
                            <option value="elem_low">ì´ˆë“± 1~2í•™ë…„</option>
                            <option value="elem_mid">ì´ˆë“± 3~4í•™ë…„</option>
                            <option value="elem_high">ì´ˆë“± 5~6í•™ë…„</option>
                            <option value="mid_1">ì¤‘ë“± 1í•™ë…„</option>
                            <option value="mid_2">ì¤‘ë“± 2í•™ë…„</option>
                            <option value="mid_3">ì¤‘ë“± 3í•™ë…„</option>
                            <option value="high_1">ê³ ë“± 1í•™ë…„</option>
                            <option value="high_2">ê³ ë“± 2í•™ë…„</option>
                            <option value="high_3">ê³ ë“± 3í•™ë…„</option>
                        </select>
                        <label class="form-label">ì£¼ì œ ëª©ë¡</label>
                        <select id="s-topic-select" class="form-select" onchange="applyTopic('Speaking')"></select>
                    </div>
                    <div class="editor-section">
                        <h3 style="font-size:16px; margin-top:0;">2. ë‚´ìš© í¸ì§‘</h3>
                        <label class="form-label">ì œëª©</label>
                        <input type="text" id="s-edit-title" class="form-input" onkeyup="updatePreview('Speaking')">
                        <label class="form-label">ê°€ì´ë“œ</label>
                        <textarea id="s-edit-prompt" class="form-textarea" onkeyup="updatePreview('Speaking')"></textarea>
                        <label class="form-label">ìœ ìš©í•œ í‘œí˜„</label>
                        <div class="hint-container"><div id="s-edit-hints" class="hint-group"></div></div>
                        <button class="btn btn-send" style="width:100%; margin-top:20px;" onclick="openAssignModal('Speaking')"><i class="fa-solid fa-paper-plane"></i> ìˆ™ì œ ì „ì†¡</button>
                    </div>
                </div>
                <div class="right-panel">
                    <div class="mobile-frame">
                        <div class="mobile-notch"></div>
                        <div class="mobile-screen">
                            <div style="text-align: center; margin-bottom: 20px;"><span style="font-size: 14px; color: #888;">Student App Preview</span></div>
                            <div class="preview-card">
                                <span class="p-tag" style="background:#E6F0FF; color:#0052CC;">Speaking</span>
                                <div class="p-title" id="s-prev-title">Title</div>
                                <div class="p-desc" id="s-prev-prompt">Prompt...</div>
                                <div class="p-hints-box" id="s-prev-hints" style="display:none;">
                                    <div class="p-hints-title"><i class="fa-regular fa-lightbulb"></i> Key Expressions</div>
                                    <ul id="s-prev-hints-list" class="p-hints-list"></ul>
                                </div>
                            </div>
                            <div style="margin-top: 30px; text-align: center;">
                                <div style="width: 60px; height: 60px; background: #E53E3E; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center; color: white;"><i class="fa-solid fa-microphone"></i></div>
                                <p style="font-size:12px; color:#999; margin-top:10px;">Tap to Record</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="s-feedback" class="sub-view" style="display:none;">
            <div class="fb-container">
                <div class="fb-list-panel">
                    <h3 style="margin-top:0;">ğŸ“¥ ì œì¶œëœ ë…¹ìŒ</h3>
                    <div id="s-submission-list"></div>
                </div>
                <div class="fb-detail-panel" id="s-detail-panel" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <div><h2 style="margin:0; font-size:20px;" id="s-fb-student">Student</h2><span style="color:#666; font-size:14px;" id="s-fb-title">Title</span></div>
                        <button class="btn-ai" onclick="generateAI('Speaking')"><i class="fa-solid fa-wand-magic-sparkles"></i> AI í”¼ë“œë°± ìƒì„±</button>
                    </div>
                    <div class="student-work-area" style="display:flex; align-items:center; justify-content:center;">
                        <div style="background:#2D3748; padding:10px 20px; border-radius:30px; display:inline-flex; align-items:center; gap:15px; color:white;">
                            <i class="fa-solid fa-play" style="cursor:pointer;"></i>
                            <div style="width:150px; height:4px; background:#4A5568; position:relative;"><div style="position:absolute; left:0; top:0; height:100%; width:40%; background:#48BB78;"></div></div>
                            <span style="font-size:12px;">00:45</span>
                        </div>
                    </div>
                    <label class="form-label">ì„ ìƒë‹˜ í”¼ë“œë°±</label>
                    <textarea id="s-fb-text" class="feedback-editor"></textarea>
                    <button class="btn btn-send" style="width:100%;" onclick="sendFeedback('Speaking')"><i class="fa-solid fa-paper-plane"></i> í”¼ë“œë°± ì „ì†¡ ë° ì™„ë£Œ</button>
                </div>
                <div class="fb-detail-panel" id="s-empty-state" style="align-items:center; justify-content:center; color:#999;"><i class="fa-solid fa-headphones" style="font-size:50px; margin-bottom:15px;"></i><p>ì™¼ìª½ ëª©ë¡ì—ì„œ ì²­ì·¨í•  ë…¹ìŒ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</p></div>
            </div>
        </div>
    </div>
</div>

<div id="assign-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top:0;">ğŸ“… ìˆ™ì œ ë°°í¬ ì„¤ì •</h3>
        <label class="form-label">ì œëª©</label>
        <input type="text" id="modal-title" class="form-input" readonly style="background:#f9f9f9;">
        <label class="form-label">ë§ˆê°ì¼</label>
        <input type="date" id="modal-date" class="form-input">
        <label class="form-label">ëŒ€ìƒ í•™ìƒ</label>
        <div class="student-chk-list" id="modal-students"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-ghost" style="flex:1;" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-send" style="flex:2;" onclick="confirmAssign()">ìˆ™ì œ ì „ì†¡</button>
        </div>
    </div>
</div>

<script type="module">
    // Firebase Data Loading
    // topicDBëŠ” ë¶„ëŸ‰ ë¬¸ì œë¡œ ì¼ë¶€ ìƒëµë˜ì—ˆìœ¼ë‚˜, ì•ì„  ì½”ë“œì— ìˆëŠ” ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const topicDB = {
        Writing: {
            "elem_low": [ { title: "My Name", prompt: "Write your name, age...", hints: ["My name is...", "I am..."] } ],
            // ... (ê¸°ì¡´ê³¼ ë™ì¼)
        },
        Speaking: {
            "elem_low": [ { title: "Self Intro", prompt: "Name and age...", hints: ["I am...", "Years old..."] } ]
            // ...
        }
    };
    // (ì´ì „ ì½”ë“œì˜ ì „ì²´ topicDB ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë³µì‚¬í•´ ë„£ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤. ë„ˆë¬´ ê¸¸ì–´ì„œ ì¶•ì•½í•¨)

    let currentFeedbackId = null;
    let submissions = [];

    // --- Tab Switching ---
    window.switchMain = function(id) {
        document.querySelectorAll('.module-view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
        document.querySelectorAll('.m-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
    }

    window.switchSub = function(id, btn) {
        const parent = btn.parentElement.parentElement;
        parent.querySelectorAll('.sub-view').forEach(v => v.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        btn.parentElement.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        if(id.includes('feedback')) {
            const type = id.includes('w-') ? 'Writing' : 'Speaking';
            loadSubmissions(type);
        }
    }

    // --- Assign Logic ---
    window.loadTopics = function(type) {
        const prefix = type === 'Writing' ? 'w' : 's';
        const grade = document.getElementById(`${prefix}-grade-select`).value;
        const select = document.getElementById(`${prefix}-topic-select`);
        
        select.innerHTML = '<option value="custom">ì§ì ‘ ì…ë ¥ (Custom Topic)</option>';
        
        // Mock data fallback if topicDB is empty in this snippet
        const topics = topicDB[type] ? (topicDB[type][grade] || []) : [];
        
        topics.forEach((t, index) => {
            const opt = document.createElement('option');
            opt.value = index;
            opt.innerText = t.title;
            select.appendChild(opt);
        });
        
        select.value = "custom";
        applyTopic(type);
    }

    window.applyTopic = function(type) {
        const prefix = type === 'Writing' ? 'w' : 's';
        const select = document.getElementById(`${prefix}-topic-select`);
        const grade = document.getElementById(`${prefix}-grade-select`).value;
        
        let data = { title: "", prompt: "", hints: [] };
        
        if (select.value !== 'custom') {
            const index = parseInt(select.value);
            if(topicDB[type] && topicDB[type][grade]) {
                data = topicDB[type][grade][index];
            }
        }

        document.getElementById(`${prefix}-edit-title`).value = data.title;
        document.getElementById(`${prefix}-edit-prompt`).value = data.prompt;
        
        const hintsDiv = document.getElementById(`${prefix}-edit-hints`);
        hintsDiv.innerHTML = '';
        
        if(data.hints.length === 0) {
             if(select.value !== 'custom') hintsDiv.innerHTML = '<span style="font-size:12px; color:#999;">(No hints)</span>';
        } else {
            data.hints.forEach(h => {
                const chip = document.createElement('div');
                chip.className = 'hint-chip';
                chip.innerText = h;
                chip.onclick = function() { this.classList.toggle('checked'); updatePreview(type); };
                hintsDiv.appendChild(chip);
            });
        }
        updatePreview(type);
    }

    window.updatePreview = function(type) {
        const prefix = type === 'Writing' ? 'w' : 's';
        const title = document.getElementById(`${prefix}-edit-title`).value;
        const prompt = document.getElementById(`${prefix}-edit-prompt`).value;
        
        document.getElementById(`${prefix}-prev-title`).innerText = title || "Title";
        document.getElementById(`${prefix}-prev-prompt`).innerText = prompt || "Prompt description...";
        
        const hintsBox = document.getElementById(`${prefix}-prev-hints`);
        const hintsList = document.getElementById(`${prefix}-prev-hints-list`);
        const checked = document.querySelectorAll(`#${prefix}-edit-hints .hint-chip.checked`);
        
        if(checked.length > 0) {
            hintsBox.style.display = 'block';
            hintsList.innerHTML = '';
            checked.forEach(c => hintsList.innerHTML += `<li>${c.innerText}</li>`);
        } else {
            hintsBox.style.display = 'none';
        }
    }

    // --- Modal & Firebase Save ---
    window.openAssignModal = function(type) {
        const prefix = type === 'Writing' ? 'w' : 's';
        const title = document.getElementById(`${prefix}-edit-title`).value;
        if(!title) return alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        document.getElementById('modal-title').value = title;
        document.getElementById('modal-date').value = new Date(Date.now() + 86400000 * 3).toISOString().split('T')[0];
        
        // Mock Students (In real app, fetch from Firebase 'users' collection)
        const students = ["ê¹€ë¯¼ì¤€", "ì´ì„œì—°"];
        const list = document.getElementById('modal-students');
        list.innerHTML = '';
        students.forEach((s, i) => {
            list.innerHTML += `<div class="chk-item"><input type="checkbox" id="st-${i}" value="${s}" checked><label for="st-${i}">${s}</label></div>`;
        });
        document.getElementById('assign-modal').style.display = 'flex';
    }
    
    window.closeModal = function() { document.getElementById('assign-modal').style.display = 'none'; }

    window.confirmAssign = async function() {
        const title = document.getElementById('modal-title').value;
        const date = document.getElementById('modal-date').value;
        const type = document.querySelector('#view-writing').classList.contains('active') ? 'Writing' : 'Speaking';
        const prefix = type === 'Writing' ? 'w' : 's';
        const prompt = document.getElementById(`${prefix}-edit-prompt`).value;
        
        const hints = [];
        document.querySelectorAll(`#${prefix}-edit-hints .hint-chip.checked`).forEach(c => hints.push(c.innerText));

        const checked = document.querySelectorAll('#modal-students input:checked');
        if(checked.length === 0) return alert("í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

        try {
            const promises = [];
            checked.forEach(chk => {
                promises.push(
                    window.addDoc(window.collection(window.db, "assignments"), {
                        id: Date.now() + Math.random(),
                        title: title,
                        type: type,
                        student: chk.value,
                        date: date,
                        status: 'missing',
                        prompt: prompt,
                        hints: hints,
                        content: null,
                        feedback: null
                    })
                );
            });
            await Promise.all(promises);
            alert('ìˆ™ì œê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeModal();
        } catch(e) {
            alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message);
        }
    }

    // --- Feedback Logic (Firebase Read) ---
    window.loadSubmissions = function(type) {
        const prefix = type === 'Writing' ? 'w' : 's';
        const listContainer = document.getElementById(`${prefix}-submission-list`);
        listContainer.innerHTML = '<div style="padding:20px; text-align:center;">ë¡œë”© ì¤‘...</div>';

        // Query: status is submitted or done, type matches
        const q = window.query(
            window.collection(window.db, "assignments"),
            window.where("type", "==", type)
        );

        window.onSnapshot(q, (snapshot) => {
            submissions = [];
            snapshot.forEach(doc => {
                const d = doc.data();
                if(d.status === 'submitted' || d.status === 'done') {
                    submissions.push({ docId: doc.id, ...d });
                }
            });

            listContainer.innerHTML = '';
            if(submissions.length === 0) {
                listContainer.innerHTML = '<div style="padding:20px; color:#999; text-align:center;">ì œì¶œëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            submissions.forEach(a => {
                const div = document.createElement('div');
                div.className = 'sub-item';
                div.innerHTML = `
                    <div class="sub-name">${a.student} ${a.status === 'done' ? '<span style="font-size:10px; color:#999;">(ì™„ë£Œ)</span>' : '<span style="color:#00875A; font-weight:bold; font-size:10px;">â— NEW</span>'}</div>
                    <div class="sub-meta"><span>${a.title}</span> <span>${a.date}</span></div>
                `;
                div.onclick = function() { openDetail(type, a.docId, this); };
                listContainer.appendChild(div);
            });
        });
    }

    window.openDetail = function(type, docId, el) {
        currentFeedbackId = docId;
        const prefix = type === 'Writing' ? 'w' : 's';
        const item = submissions.find(a => a.docId === docId);

        el.parentElement.querySelectorAll('.sub-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.getElementById(`${prefix}-empty-state`).style.display = 'none';
        document.getElementById(`${prefix}-detail-panel`).style.display = 'flex';

        document.getElementById(`${prefix}-fb-student`).innerText = item.student;
        document.getElementById(`${prefix}-fb-title`).innerText = item.title;
        document.getElementById(`${prefix}-fb-text`).value = item.feedback || "";

        if(type === 'Writing') {
            document.getElementById('w-fb-content').innerText = item.content || "(ë‚´ìš© ì—†ìŒ)";
        }
    }

    window.generateAI = function(type) {
        const prefix = type === 'Writing' ? 'w' : 's';
        const editor = document.getElementById(`${prefix}-fb-text`);
        editor.value = "AI ë¶„ì„ ì¤‘...";
        setTimeout(() => {
            editor.value = type === 'Writing' ? "[AI ë¶„ì„] ë¬¸ë²• ì •í™•ë„ 90%. \n[ì œì•ˆ] 'I have a dog' ë¬¸ì¥ì„ ë” ìì„¸íˆ ì¨ë³´ì„¸ìš”." : "[AI ë¶„ì„] ìœ ì°½ì„± 8/10. \n[ì œì•ˆ] ëª©ì†Œë¦¬ í†¤ì„ ì¡°ê¸ˆ ë” ë†’ì—¬ë³´ì„¸ìš”.";
        }, 800);
    }

    window.sendFeedback = async function(type) {
        const prefix = type === 'Writing' ? 'w' : 's';
        const feedback = document.getElementById(`${prefix}-fb-text`).value;
        
        try {
            const docRef = window.doc(window.db, "assignments", currentFeedbackId);
            await window.updateDoc(docRef, {
                status: 'done',
                feedback: feedback
            });
            alert('í”¼ë“œë°±ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch(e) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
        }
    }

    // Initialize
    window.addEventListener('load', () => {
        if(window.location.hash === '#feedback') {
            const btnWriting = document.getElementById('btn-w-feedback');
            switchSub('w-feedback', btnWriting);
        }
        loadTopics('Writing');
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yoon's Student App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* (CSS ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) */
        body { margin: 0; padding: 0; background: #F4F5F7; font-family: 'Noto Sans KR', sans-serif; color: #333; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; }
        .app-header { padding: 20px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .logo { font-weight: 900; color: #0052CC; font-size: 18px; }
        .user-select { font-size: 13px; border: 1px solid #ddd; padding: 5px 10px; border-radius: 20px; background: #f9f9f9; }
        .content { flex: 1; padding: 20px; }
        .section-title { font-size: 16px; font-weight: 800; margin-bottom: 15px; color: #1A1F36; }
        
        .task-card { background: white; border: 1px solid #E3E8EE; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: 0.2s; cursor: pointer; position: relative; overflow: hidden; }
        .task-card:active { transform: scale(0.98); background: #f0f2f5; }
        .task-card::before { content: ''; position: absolute; left: 0; top: 0; width: 4px; height: 100%; }
        
        .type-exam { border-left: 4px solid #0052CC; }
        .type-writing { border-left: 4px solid #00875A; }
        .type-speaking { border-left: 4px solid #B76E00; }

        .tag { font-size: 10px; padding: 3px 6px; border-radius: 4px; font-weight: 700; display: inline-block; margin-bottom: 8px; }
        .tag.exam { background: #E6F0FF; color: #0052CC; }
        .tag.writing { background: #E3FCEF; color: #00875A; }
        .tag.speaking { background: #FFFAE6; color: #B76E00; }
        
        .task-title { font-weight: 700; font-size: 15px; margin-bottom: 5px; }
        .task-date { font-size: 12px; color: #888; }

        .detail-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: none; flex-direction: column; }
        .detail-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
        .back-btn { font-size: 20px; cursor: pointer; color: #333; }
        .detail-body { flex: 1; padding: 25px 20px; overflow-y: auto; display: flex; flex-direction: column; }
        
        .task-info-box { margin-bottom: 30px; }
        .ti-title { font-size: 22px; font-weight: 800; margin-bottom: 10px; line-height: 1.3; }
        .ti-prompt { font-size: 15px; color: #555; line-height: 1.6; margin-bottom: 15px; background: #F8F9FB; padding: 15px; border-radius: 8px; }
        .hint-label { font-size: 12px; font-weight: bold; color: #B76E00; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .hint-chip { display: inline-block; font-size: 12px; padding: 5px 10px; background: #FFF9C4; color: #555; border-radius: 15px; margin-right: 5px; margin-bottom: 5px; border: 1px solid #FEEBC8; }

        .writing-area { width: 100%; height: 250px; padding: 15px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; line-height: 1.6; resize: none; margin-bottom: 20px; font-family: inherit; }
        .writing-area:focus { outline: none; border-color: #0052CC; }

        .record-area { text-align: center; margin-top: 20px; }
        .mic-btn { width: 80px; height: 80px; background: #E53E3E; border-radius: 50%; color: white; font-size: 30px; border: none; box-shadow: 0 10px 20px rgba(229, 62, 62, 0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; transition: 0.2s; }
        .mic-btn.recording { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .review-box { display: none; background: #2D3748; padding: 15px 25px; border-radius: 40px; align-items: center; gap: 20px; color: white; margin: 0 auto 20px; width: fit-content; }
        .review-actions { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .btn-icon-round { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ddd; background: white; display: flex; align-items: center; justify-content: center; color: #555; cursor: pointer; }

        .exam-area { text-align: center; }
        .pdf-link { display: block; padding: 15px; background: #E3F2FD; color: #0052CC; text-decoration: none; border-radius: 8px; font-weight: bold; margin-bottom: 30px; }
        .upload-box { border: 2px dashed #ccc; border-radius: 12px; padding: 40px 20px; text-align: center; color: #888; cursor: pointer; transition: 0.2s; }
        .upload-box.active { border-color: #0052CC; color: #0052CC; background: #F0F4FF; }
        
        .submit-btn { width: 100%; padding: 16px; background: #0052CC; color: white; border: none; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: auto; }
        .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
        .empty-state { text-align: center; padding: 50px 20px; color: #999; }
    </style>
    <script type="module" src="firebase-config.js"></script>
</head>
<body>

<div class="app-container">
    <div class="app-header">
    <div class="logo">Yoon's Class Booster</div>
    <div style="display:flex; align-items:center; gap:10px;">
        <span id="header-user-name" style="font-size:14px; font-weight:bold; color:#333;">ë¡œë”© ì¤‘...</span>
        <i class="fa-solid fa-right-from-bracket" onclick="window.handleLogout()" style="cursor:pointer; color:#888;"></i>
    </div>
</div>

    <div class="content">
        <div style="background: #FFF8E1; padding: 15px; border-radius: 8px; font-size: 13px; color: #B76E00; margin-bottom: 20px; line-height: 1.4; border: 1px solid #FFE082;">
            ğŸ‘‹ <strong><span id="user-name">ê¹€ë¯¼ì¤€</span> í•™ìƒ, ì•ˆë…•í•˜ì„¸ìš”!</strong><br>
            ì˜¤ëŠ˜ ëë‚´ì•¼ í•  ë¯¸ì…˜ì´ ë„ì°©í•´ ìˆìŠµë‹ˆë‹¤.
        </div>

        <div class="section-title">To-Do List ğŸ“</div>
        <div id="todo-list">
            <div class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...</div>
        </div>
    </div>
</div>

<div id="detail-view" class="detail-view">
    <div class="detail-header">
        <i class="fa-solid fa-arrow-left back-btn" onclick="window.closeDetail()"></i>
        <h3 style="font-size: 16px; margin: 0;" id="dt-header-title">Homework</h3>
    </div>
    
    <div class="detail-body">
        <div class="task-info-box">
            <div class="ti-title" id="dt-title">Title</div>
            <div class="ti-prompt" id="dt-prompt">Prompt text...</div>
            <div class="ti-hints" id="dt-hints-area" style="display:none;">
                <div class="hint-label"><i class="fa-regular fa-lightbulb"></i> Key Expressions</div>
                <div id="dt-hints-list"></div>
            </div>
        </div>

        <div id="input-container">
            <div id="input-writing" style="display:none;">
                <textarea id="w-text" class="writing-area" placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
            </div>

            <div id="input-speaking" style="display:none;">
                <div class="record-area">
                    <div id="rec-control">
                        <button id="mic-btn" class="mic-btn" onclick="window.toggleRecord()">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                        <p id="rec-status" style="font-weight:bold; color:#555;">í„°ì¹˜í•˜ì—¬ ë…¹ìŒ ì‹œì‘</p>
                    </div>
                    <div id="rec-review" style="display:none;">
                        <div class="review-box" onclick="window.playAudio()">
                            <i class="fa-solid fa-play" id="play-icon"></i>
                            <div style="width:100px; height:4px; background:#4A5568;"></div>
                            <span style="font-size:12px;">Review</span>
                        </div>
                        <div class="review-actions">
                            <div onclick="window.resetRecorder()" style="text-align:center; cursor:pointer;">
                                <div class="btn-icon-round"><i class="fa-solid fa-rotate-left"></i></div>
                                <span style="font-size:11px; color:#666; display:block; margin-top:5px;">ë‹¤ì‹œ ë…¹ìŒ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="input-exam" style="display:none;">
                <div class="exam-area">
                    <a href="#" class="pdf-link" onclick="alert('PDF íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹œë®¬ë ˆì´ì…˜)')">
                        <i class="fa-solid fa-file-pdf"></i> ë¬¸ì œì§€ ë‹¤ìš´ë¡œë“œ (PDF)
                    </a>
                    
                    <input type="file" id="file-upload" accept="image/*" style="display:none;" onchange="window.handleFileSelect(this)">
                    <div class="upload-box" id="upload-box" onclick="document.getElementById('file-upload').click()">
                        <div id="upload-placeholder">
                            <i class="fa-solid fa-camera" style="font-size:40px; margin-bottom:10px;"></i>
                            <p style="margin:0; font-weight:bold;">ë‹µì•ˆì§€ ì´¬ì˜ ë˜ëŠ” ì—…ë¡œë“œ</p>
                            <p style="font-size:12px; margin-top:5px;">(ì—¬ê¸°ë¥¼ í„°ì¹˜í•˜ì„¸ìš”)</p>
                        </div>
                        <div id="file-name" style="margin-top:15px; color:#00875A; font-weight:bold; display:none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="btn-submit" class="submit-btn" onclick="window.handleSubmit()">ì œì¶œí•˜ê¸°</button>
</div>

<script type="module">
    // Import
    import { auth, db } from "./firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, query, where, onSnapshot, doc, updateDoc, getDocs } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Global Variables
    let currentUserData = null; // Firestore User Data
    let myTasks = [];
    let currentTask = null;
    
    // Speaking Variables
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob = null;
    let audioUrl = null;
    let isRecording = false;

    // 1. Auth & Data Loading
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.replace("login.html");
            return;
        }

        // Firestoreì—ì„œ ì‚¬ìš©ì ì •ë³´(ì´ë¦„) ê°€ì ¸ì˜¤ê¸°
        // *ì£¼ì˜: 1ì°¨ ì‘ì—…ì˜ uidì™€ Authì˜ uidê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì´ë©”ì¼ë¡œ ë§¤ì¹­í•©ë‹ˆë‹¤.
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("email", "==", user.email));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            const userDoc = querySnapshot.docs[0];
            currentUserData = userDoc.data();
            console.log("User Loaded:", currentUserData.name);
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('header-user-name').innerText = currentUserData.name;
            document.getElementById('user-name').innerText = currentUserData.name;
            
            // ê³¼ì œ ë¡œë“œ ì‹œì‘
            loadMyTasks(currentUserData.name);
        } else {
            alert("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”.");
            signOut(auth);
        }
    });

    // 2. Load Tasks (Realtime)
    function loadMyTasks(studentName) {
        const listContainer = document.getElementById('todo-list');
        listContainer.innerHTML = '<div class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i> ê³¼ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        // 1ì°¨ ì‘ì—… ìŠ¤í‚¤ë§ˆì— ë”°ë¼ 'student' í•„ë“œ(ì´ë¦„)ë¡œ ì¿¼ë¦¬
        const q = query(
            collection(db, "assignments"), 
            where("student", "==", studentName)
        );

        onSnapshot(q, (snapshot) => {
            myTasks = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                // ë¯¸ì™„ë£Œ(missing) ë˜ëŠ” í• ë‹¹ë¨(assigned) ìƒíƒœë§Œ í‘œì‹œ
                if(data.status === 'missing' || data.status === 'assigned') {
                    myTasks.push({ docId: doc.id, ...data });
                }
            });
            renderList();
        }, (error) => {
            console.error("Error loading tasks:", error);
            listContainer.innerHTML = '<div class="empty-state">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
        });
    }

    // 3. Render List
    function renderList() {
        const container = document.getElementById('todo-list');
        container.innerHTML = '';

        if(myTasks.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fa-solid fa-check-circle" style="color:#00875A; font-size:40px; margin-bottom:15px;"></i><br>ì•¼í˜¸! ëª¨ë“  ìˆ™ì œë¥¼ ëëƒˆì–´ìš”.</div>';
            return;
        }

        // ë‚ ì§œìˆœ ì •ë ¬
        myTasks.sort((a,b) => new Date(b.date) - new Date(a.date));

        myTasks.forEach(t => {
            let typeClass = 'type-exam';
            let tagClass = 'exam';
            if(t.type === 'Writing') { typeClass = 'type-writing'; tagClass = 'writing'; }
            if(t.type === 'Speaking') { typeClass = 'type-speaking'; tagClass = 'speaking'; }

            container.innerHTML += `
                <div class="task-card ${typeClass}" onclick="window.openTask('${t.docId}')">
                    <span class="tag ${tagClass}">${t.type}</span>
                    <div class="task-title">${t.title}</div>
                    <div class="task-date"><i class="fa-regular fa-calendar"></i> ${t.date} ê¹Œì§€</div>
                </div>
            `;
        });
    }

    // 4. Task Detail Actions
    window.openTask = function(docId) {
        currentTask = myTasks.find(t => t.docId === docId);
        if(!currentTask) return;

        // Reset & UI Setup (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        window.resetRecorder();
        window.resetFileUpload();
        document.getElementById('btn-submit').disabled = false;

        document.getElementById('dt-header-title').innerText = `${currentTask.type} Homework`;
        document.getElementById('dt-title').innerText = currentTask.title;
        document.getElementById('dt-prompt').innerText = currentTask.prompt || "ê°€ì´ë“œ ì—†ìŒ";

        // Hints Handling
        const hintArea = document.getElementById('dt-hints-area');
        const hintList = document.getElementById('dt-hints-list');
        if(currentTask.hints && currentTask.hints.length > 0) {
            hintArea.style.display = 'block';
            hintList.innerHTML = currentTask.hints.map(h => `<span class="hint-chip">${h}</span>`).join('');
        } else {
            hintArea.style.display = 'none';
        }

        // View Toggle
        ['input-writing', 'input-speaking', 'input-exam'].forEach(id => document.getElementById(id).style.display = 'none');

        if(currentTask.type === 'Writing') {
            document.getElementById('input-writing').style.display = 'block';
            document.getElementById('w-text').value = '';
        } else if(currentTask.type === 'Speaking') {
            document.getElementById('input-speaking').style.display = 'block';
            document.getElementById('btn-submit').disabled = true;
        } else if(currentTask.type === 'Exam') {
            document.getElementById('input-exam').style.display = 'block';
            document.getElementById('btn-submit').disabled = true;
        }

        document.getElementById('detail-view').style.display = 'flex';
    }

    window.closeDetail = function() {
        document.getElementById('detail-view').style.display = 'none';
        currentTask = null;
    }

    // 5. Utility Functions (ê¸°ì¡´ ìœ ì§€)
    window.resetRecorder = function() {
        isRecording = false;
        audioBlob = null;
        const btn = document.getElementById('mic-btn');
        if(btn) {
            btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
            btn.classList.remove('recording');
        }
        document.getElementById('rec-control').style.display = 'block';
        document.getElementById('rec-review').style.display = 'none';
        document.getElementById('rec-status').innerText = "í„°ì¹˜í•˜ì—¬ ë…¹ìŒ ì‹œì‘";
    }

    window.toggleRecord = async function() {
        // ... (ë…¹ìŒ ë¡œì§ 4ë‹¨ê³„ì—ì„œ êµ¬í˜„ ì˜ˆì •, í˜„ì¬ëŠ” UIë™ì‘ë§Œ) ...
        alert("ë…¹ìŒ ê¸°ëŠ¥ì€ 4ë‹¨ê³„(Storage ì—°ë™)ì—ì„œ í™œì„±í™”ë©ë‹ˆë‹¤.");
    }
    window.playAudio = function() { if(audioUrl) new Audio(audioUrl).play(); }
    
    window.handleFileSelect = function(input) {
        if(input.files && input.files[0]) {
            document.getElementById('upload-box').classList.add('active');
            document.getElementById('upload-placeholder').style.display = 'none';
            document.getElementById('file-name').style.display = 'block';
            document.getElementById('file-name').innerText = input.files[0].name;
            document.getElementById('btn-submit').disabled = false;
        }
    }
    
    window.resetFileUpload = function() {
        document.getElementById('upload-box').classList.remove('active');
        document.getElementById('upload-placeholder').style.display = 'block';
        document.getElementById('file-name').style.display = 'none';
        document.getElementById('file-upload').value = '';
    }

    // 6. Submit Logic (Firestore Update)
    window.handleSubmit = async function() {
        if(!currentTask) return;
        
        // ë°ì´í„° ì¤€ë¹„
        let updateData = {
            status: 'submitted',
            submittedAt: new Date().toISOString()
        };

        if(currentTask.type === 'Writing') {
            const content = document.getElementById('w-text').value;
            if(content.length < 2) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            updateData.content = content;
        } 
        // Speaking, Examì˜ íŒŒì¼ ì—…ë¡œë“œëŠ” 4ë‹¨ê³„ì—ì„œ êµ¬í˜„
        else {
            if(!confirm("íŒŒì¼/ë…¹ìŒ ì—…ë¡œë“œ ê¸°ëŠ¥ì€ 4ë‹¨ê³„ ì˜ˆì •ì…ë‹ˆë‹¤. 'ì œì¶œ ì™„ë£Œ' ìƒíƒœë¡œë§Œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        }

        try {
            await updateDoc(doc(db, "assignments", currentTask.docId), updateData);
            alert("ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!");
            window.closeDetail();
        } catch(e) {
            alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message);
        }
    }

    // 7. Logout Helper
    window.handleLogout = function() {
        signOut(auth).then(() => window.location.href = 'login.html');
    }
</script>
</body>
</html>
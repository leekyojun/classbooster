<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Homework Management Center</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* (기존 CSS 스타일 그대로 유지 - 생략) */
        body { padding: 30px; background: #F0F2F5; font-family: 'Noto Sans KR', sans-serif; color: #333; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .s-card { background: white; padding: 20px 25px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .s-label { font-size: 13px; color: #666; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .s-val { font-size: 32px; font-weight: 900; color: #1A1F36; margin-top: 5px; }
        .s-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .main-card { background: white; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow: hidden; }
        .toolbar { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .tab-group { display: flex; gap: 5px; background: #f0f2f5; padding: 4px; border-radius: 8px; }
        .tab-btn { padding: 8px 16px; border-radius: 6px; border: none; font-size: 13px; font-weight: bold; cursor: pointer; color: #666; background: transparent; transition: 0.2s; }
        .tab-btn.active { background: white; color: #0052CC; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .search-box { position: relative; width: 300px; }
        .search-input { width: 100%; padding: 10px 15px 10px 35px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; transition: 0.2s; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #aaa; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th { background: #f8f9fb; padding: 15px; text-align: left; font-weight: bold; color: #555; border-bottom: 2px solid #eee; cursor: pointer; user-select: none; }
        .data-table td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .type-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 800; text-transform: uppercase; }
        .t-exam { background: #E3F2FD; color: #1565C0; }
        .t-writing { background: #E8F5E9; color: #2E7D32; }
        .t-speaking { background: #FFF8E1; color: #F9A825; }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; font-weight: 600; font-size: 13px; }
        .st-missing { color: #E53E3E; }
        .st-submit { color: #38A169; }
        .st-done { color: #718096; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .btn-sm { padding: 6px 12px; border-radius: 6px; border: none; font-size: 12px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .btn-remind { background: #FFF5F5; color: #C53030; border: 1px solid #FEB2B2; }
        .btn-check { background: #F0FFF4; color: #2F855A; border: 1px solid #9AE6B4; }
        .btn-del { background: white; border: 1px solid #ddd; color: #666; }
        .chk-custom { width: 16px; height: 16px; cursor: pointer; }
        .empty-row { text-align: center; padding: 40px; color: #999; }
    </style>
    <script type="module" src="firebase-config.js"></script>
</head>
<body>

    <div class="summary-grid">
        <div class="s-card">
            <div><div class="s-label">Total Assignments</div><div class="s-val" id="sum-total">0</div></div>
            <div class="s-icon" style="background:#E3F2FD; color:#1565C0;"><i class="fa-solid fa-layer-group"></i></div>
        </div>
        <div class="s-card">
            <div><div class="s-label">Action Needed (Submitted)</div><div class="s-val" id="sum-submit" style="color:#2E7D32;">0</div></div>
            <div class="s-icon" style="background:#E8F5E9; color:#2E7D32;"><i class="fa-solid fa-pen-to-square"></i></div>
        </div>
        <div class="s-card">
            <div><div class="s-label">Missing (Remind)</div><div class="s-val" id="sum-missing" style="color:#C62828;">0</div></div>
            <div class="s-icon" style="background:#FFEBEE; color:#C62828;"><i class="fa-solid fa-bell"></i></div>
        </div>
    </div>

    <div class="main-card">
        <div class="toolbar">
            <div style="display:flex; align-items:center; gap:15px;">
                <h2 style="margin:0; font-size:18px; color:#333;"><i class="fa-solid fa-list-check"></i> 과제 목록</h2>
                <div class="tab-group">
                    <button class="tab-btn active" onclick="setFilter('all', this)">전체</button>
                    <button class="tab-btn" onclick="setFilter('Exam', this)">Exam</button>
                    <button class="tab-btn" onclick="setFilter('Writing', this)">Writing</button>
                    <button class="tab-btn" onclick="setFilter('Speaking', this)">Speaking</button>
                </div>
            </div>
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" class="search-input" placeholder="학생 이름 검색..." onkeyup="handleSearch(this.value)">
            </div>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th width="5%"><input type="checkbox" class="chk-custom"></th>
                    <th width="10%">유형</th>
                    <th width="30%">과제명</th>
                    <th width="15%">학생명</th>
                    <th width="15%">마감일</th>
                    <th width="10%">상태</th>
                    <th width="15%">관리</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="7" class="empty-row"><i class="fa-solid fa-spinner fa-spin"></i> 데이터 로딩 중...</td></tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        // Firebase 객체는 firebase-config.js에서 window 객체에 로드됨을 가정
        // 모듈 스크립트 내부에서는 window 객체를 통해 접근하거나, 
        // 안전하게 페이지 로드 후 실행되도록 함.

        let assignments = []; // 로컬 데이터 캐시
        let currentFilter = 'all';
        let currentSearch = '';

        // 1. 실시간 데이터 리스너 설정
        window.addEventListener('load', () => {
            const q = window.query(window.collection(window.db, "assignments"), window.orderBy("date", "desc"));
            
            window.onSnapshot(q, (snapshot) => {
                assignments = [];
                snapshot.forEach((doc) => {
                    assignments.push({ id: doc.id, ...doc.data() });
                });
                renderTable();
                updateStats();
            });
        });

        // 2. 렌더링 함수
        window.renderTable = function() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            let data = assignments;

            // 필터링
            if(currentFilter !== 'all') {
                data = data.filter(a => a.type === currentFilter);
            }
            if(currentSearch) {
                data = data.filter(a => a.student.includes(currentSearch) || a.title.includes(currentSearch));
            }

            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-row">데이터가 없습니다.</td></tr>';
                return;
            }

            data.forEach(item => {
                // 배지 설정
                let typeBadge = `<span class="type-badge t-exam">Exam</span>`;
                if(item.type === 'Writing') typeBadge = `<span class="type-badge t-writing">Writing</span>`;
                if(item.type === 'Speaking') typeBadge = `<span class="type-badge t-speaking">Speaking</span>`;

                // 상태 및 액션 설정
                let statusHtml = '';
                let actionHtml = '';

                if(item.status === 'missing') {
                    statusHtml = `<div class="status-badge st-missing"><div class="dot" style="background:#E53E3E"></div>미제출</div>`;
                    actionHtml = `<button class="btn-sm btn-remind" onclick="sendRemind('${item.student}')"><i class="fa-solid fa-bell"></i> 독촉</button>`;
                } else if(item.status === 'submitted') {
                    statusHtml = `<div class="status-badge st-submit"><div class="dot" style="background:#38A169"></div>제출됨</div>`;
                    if(item.type !== 'Exam') {
                        actionHtml = `<button class="btn-sm btn-check" onclick="parent.moveToModule('output', 'feedback')"><i class="fa-solid fa-pen"></i> 채점하기</button>`;
                    } else {
                        actionHtml = `<span style="font-size:12px; color:#999;">자동채점</span>`;
                    }
                } else {
                    statusHtml = `<div class="status-badge st-done"><div class="dot" style="background:#718096"></div>완료</div>`;
                    actionHtml = `<button class="btn-sm btn-del" onclick="deleteAssignment('${item.id}')"><i class="fa-solid fa-trash"></i></button>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="chk-custom"></td>
                    <td>${typeBadge}</td>
                    <td style="font-weight:600;">${item.title}</td>
                    <td>${item.student}</td>
                    <td>${item.date}</td>
                    <td>${statusHtml}</td>
                    <td>${actionHtml}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 3. 통계 업데이트
        function updateStats() {
            document.getElementById('sum-total').innerText = assignments.length;
            document.getElementById('sum-submit').innerText = assignments.filter(a => a.status === 'submitted').length;
            document.getElementById('sum-missing').innerText = assignments.filter(a => a.status === 'missing').length;
        }

        // 4. 전역 함수 (이벤트 핸들러용)
        window.setFilter = function(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderTable();
        }

        window.handleSearch = function(val) {
            currentSearch = val;
            renderTable();
        }

        window.deleteAssignment = async function(id) {
            if(confirm('정말 삭제하시겠습니까?')) {
                await window.deleteDoc(window.doc(window.db, "assignments", id));
            }
        }

        window.sendRemind = function(name) {
            alert(`[알림] ${name} 학생에게 카카오톡 알림을 전송했습니다.`);
        }
    </script>
</body>
</html>